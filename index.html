<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌙 Dark Thila Edition</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --voice-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --bg-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      --card-bg: rgba(255, 255, 255, 0.05);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --accent-color: #00d4ff;
      --success-color: #00ff88;
      --error-color: #ff4757;
      --voice-active: #ff6b6b;
      --border-color: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 10px;
      font-family: "Noto Sans Sinhala", "Poppins", Arial, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    .chat-container {
      width: 95%;
      max-width: 900px;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      padding: 30px;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.3),
        0 0 0 1px var(--border-color),
        inset 0 1px 0 rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 900px;
      min-height: 600px;
      animation: slideIn 0.8s ease-out;
      position: relative;
      overflow: hidden;
    }

    .chat-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-gradient);
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 32px;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 3s ease-in-out infinite alternate;
      position: relative;
    }

    @keyframes titleGlow {
      0% { filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.5)); }
      100% { filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.8)); }
    }
    
    .subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 500;
      margin-bottom: 10px;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      border-radius: 12px;
      padding: 8px 16px;
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 10px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
      animation: pulse 2s infinite;
    }

    .voice-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .voice-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .voice-indicator.listening {
      background: var(--voice-active);
      animation: voicePulse 1s infinite;
    }

    .voice-indicator.speaking {
      background: var(--accent-color);
      animation: voicePulse 1s infinite;
    }

    @keyframes voicePulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.7; }
    }

    .message-counter {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 0 10px 0 0;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-color) transparent;
      position: relative;
    }
    
    .messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .messages::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 3px;
    }

    .message {
      margin: 15px 0;
      padding: 16px 20px;
      border-radius: 20px;
      line-height: 1.6;
      max-width: 80%;
      word-wrap: break-word;
      animation: messageSlide 0.5s ease;
      position: relative;
      font-size: 15px;
    }

    .message.voice-message {
      border: 2px solid var(--voice-active);
      box-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
    }

    .voice-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 5px;
    }

    .voice-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 10px;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-btn:hover {
      background: var(--accent-color);
      color: white;
      transform: scale(1.1);
    }

    @keyframes messageSlide {
      from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    .user {
      background: var(--primary-gradient);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .bot {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 5px;
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    .bot::before {
      content: '🤖';
      position: absolute;
      left: -10px;
      top: -5px;
      font-size: 20px;
      background: var(--card-bg);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-color);
    }
    
    .loading {
      color: var(--accent-color);
      font-style: italic;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { color: transparent; text-shadow: .25em 0 0 transparent, .5em 0 0 transparent; }
      40% { color: var(--accent-color); text-shadow: .25em 0 0 transparent, .5em 0 0 transparent; }
      60% { text-shadow: .25em 0 0 var(--accent-color), .5em 0 0 transparent; }
      80%, 100% { text-shadow: .25em 0 0 var(--accent-color), .5em 0 0 var(--accent-color); }
    }
    
    .error {
      color: var(--error-color);
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .input-container {
      margin-top: 20px;
      position: relative;
    }

    .input-box {
      display: flex;
      background: var(--glass-bg);
      border-radius: 20px;
      padding: 5px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .input-box:focus-within {
      border-color: var(--accent-color);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }

    .input-box.listening {
      border-color: var(--voice-active);
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
    }

    textarea {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-primary);
      padding: 15px;
      resize: none;
      font-size: 16px;
      font-family: inherit;
      min-height: 20px;
      max-height: 120px;
    }
    
    textarea::placeholder {
      color: var(--text-secondary);
    }

    .voice-input-btn {
      background: var(--voice-gradient);
      border: none;
      border-radius: 15px;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 18px;
      color: white;
      transition: all 0.3s ease;
      margin-right: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
    }

    .voice-input-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
    }

    .voice-input-btn.listening {
      background: var(--error-color);
      animation: voiceListening 1s infinite;
    }

    @keyframes voiceListening {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .send-button {
      background: var(--primary-gradient);
      border: none;
      border-radius: 15px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 100px;
      justify-content: center;
    }

    .send-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .send-button:active {
      transform: translateY(0);
    }
    
    .send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: var(--accent-color);
      color: white;
      transform: translateY(-1px);
    }

    .voice-settings {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 8px 15px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .voice-toggle {
      position: relative;
      width: 40px;
      height: 20px;
      background: var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .voice-toggle.active {
      background: var(--success-color);
    }

    .voice-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .voice-toggle.active::after {
      transform: translateX(20px);
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      color: var(--accent-color);
      font-size: 14px;
      margin: 10px 0;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-color);
      animation: typingDots 1.4s ease-in-out infinite both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingDots {
      0%, 80%, 100% { 
        transform: scale(0);
        opacity: 0.5;
      }
      40% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: scale(0.9) translateY(50px);
      }
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.95); }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 5px;
        overflow-y: auto;
      }
      
      .chat-container {
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        min-height: 100vh;
        padding: 15px;
        border-radius: 0;
        margin: 0;
      }
      
      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }
      
      .subtitle {
        font-size: 12px;
        margin-bottom: 10px;
      }

      .status-bar {
        padding: 6px 12px;
        margin-bottom: 15px;
        font-size: 12px;
        flex-direction: column;
        gap: 5px;
      }

      .messages {
        padding-right: 5px;
        margin-bottom: 10px;
      }
      
      .message {
        max-width: 85%;
        padding: 10px 14px;
        font-size: 14px;
        margin: 8px 0;
        border-radius: 18px;
      }

      .bot::before {
        left: -8px;
        top: -3px;
        width: 24px;
        height: 24px;
        font-size: 16px;
      }

      .input-container {
        margin-top: 10px;
      }

      .input-box {
        padding: 4px;
        border-radius: 16px;
      }
      
      textarea {
        font-size: 16px;
        padding: 12px;
        line-height: 1.4;
      }

      .voice-input-btn {
        padding: 10px 12px;
        font-size: 16px;
        min-width: 44px;
      }
      
      .send-button {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 12px;
        min-width: 80px;
      }

      .action-buttons {
        gap: 6px;
        margin-top: 10px;
        justify-content: center;
      }

      .action-btn {
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 10px;
        flex: 1;
        min-width: 60px;
        text-align: center;
      }

      .voice-settings {
        margin-top: 8px;
        padding: 6px 12px;
        font-size: 11px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .typing-indicator {
        font-size: 12px;
        margin: 8px 0;
      }
    }
    
    @media (max-width: 480px) {
      .chat-container {
        padding: 10px;
      }

      h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 11px;
      }
      
      .input-box {
        padding: 3px;
        flex-direction: row;
      }

      textarea {
        padding: 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .voice-input-btn {
        margin-right: 3px;
        padding: 8px 10px;
        min-width: 40px;
        font-size: 14px;
      }

      .send-button {
        padding: 8px 12px;
        justify-content: center;
        border-radius: 12px;
        min-width: 70px;
        font-size: 12px;
      }

      .message {
        max-width: 90%;
        font-size: 13px;
        padding: 8px 12px;
      }

      .action-buttons {
        flex-wrap: wrap;
        gap: 5px;
      }

      .action-btn {
        font-size: 10px;
        padding: 5px 8px;
        min-width: calc(50% - 2.5px);
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .send-button, .action-btn, .voice-input-btn {
        min-height: 44px;
      }

      textarea {
        min-height: 44px;
      }

      .input-box:focus-within {
        transform: none;
      }

      .send-button:hover, .action-btn:hover, .voice-input-btn:hover {
        transform: none;
      }

      .send-button:active, .action-btn:active, .voice-input-btn:active {
        transform: scale(0.98);
        opacity: 0.8;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <h1>🌙 NOVA MIND AI </h1>
      <div class="subtitle">🤖 Powered By NOVA MIND AI  🎤</div>
    </div>
    
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>සජීවී</span>
      </div>
      <div class="voice-status">
        <div class="voice-indicator" id="voice-indicator"></div>
        <span id="voice-status">nova mind</span>
      </div>
      <div class="message-counter">
        <span id="message-count">0</span> message
      </div>
    </div>
    
    <div class="messages" id="messages">
      <div class="message bot">
        🙏 ආයුබෝවන්! මම NOVA MIND AI සහායකයා. ඔබේ ප්‍රශ්න කියන්න හෝ ටයිප් කරන්න!
        <div class="voice-controls">
          <button class="voice-btn" onclick="speakMessage(this)" title="කටහඬින් අසන්න">🔊</button>
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typing-indicator">
      <span>NOVA MIND AI පිළිතුර සකස් කරයි</span>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
    
    <div class="input-container">
      <div class="input-box" id="input-box">
        <button class="voice-input-btn" id="voice-btn" title="කටහඬින් කතා කරන්න">
          🎤
        </button>
        <textarea 
          id="prompt-input" 
          placeholder="ඔබේ ප්‍රශ්න මෙතන ලියන්න... (Enter = යවන්න, Shift+Enter = නව පේළිය)"
          rows="1"
        ></textarea>
        <button class="send-button" id="submit-btn">
          <span>➡️</span>
          <span>යවන්න</span>
        </button>
      </div>
      
      <div class="voice-settings">
        <span>කටහඬ ස්වයංක්‍රීය:</span>
        <div class="voice-toggle" id="voice-toggle" onclick="toggleVoiceOutput()"></div>
        <span id="voice-toggle-text">අක්‍රීය</span>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn" onclick="insertSample('ගණිතය')">📢 ගණිතය</button>
        <button class="action-btn" onclick="insertSample('විද්‍යාව')">🧪 විද්‍යාව</button>
        <button class="action-btn" onclick="insertSample('ඉතිහාසය')">📚 ඉතිහාසය</button>
        <button class="action-btn" onclick="insertSample('තාක්‍ෂණය')">💻 තාක්‍ෂණය</button>
        <button class="action-btn" onclick="clearChat()">🗑️ මකන්න</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // ⚠️ Production වලට backend server එකක් use කරන්න
    const API_KEY = "AIzaSyCHdCPUyJUNqZL2gtX0wfmO7q-hsyVFMYA";
    
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-flash",
      generationConfig: {
        temperature: 0.8,
        topP: 0.9,
        maxOutputTokens: 2000,
      }
    });

    // DOM Elements
    const button = document.getElementById("submit-btn");
    const promptInput = document.getElementById("prompt-input");
    const messagesDiv = document.getElementById("messages");
    const typingIndicator = document.getElementById("typing-indicator");
    const messageCounter = document.getElementById("message-count");
    const voiceBtn = document.getElementById("voice-btn");
    const voiceIndicator = document.getElementById("voice-indicator");
    const voiceStatus = document.getElementById("voice-status");
    const voiceToggle = document.getElementById("voice-toggle");
    const voiceToggleText = document.getElementById("voice-toggle-text");
    const inputBox = document.getElementById("input-box");
    
    // Voice variables
    let isListening = false;
    let recognition = null;
    let speechSynthesis = window.speechSynthesis;
    let autoVoiceOutput = false;
    let isSpeaking = false;
    let conversationHistory = [];
    let messageCount = 0;
    let isGenerating = false;

    // Initialize Speech Recognition
    function initializeSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'si-LK'; // Sinhala primary, will fallback to en-US
        
        recognition.onstart = function() {
          isListening = true;
          voiceBtn.classList.add('listening');
          inputBox.classList.add('listening');
          voiceIndicator.classList.add('listening');
          voiceStatus.textContent = 'අසනවා...';
        };
        
        recognition.onresult = function(event) {
          let finalTranscript = '';
          let interimTranscript = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }
          
          if (finalTranscript) {
            promptInput.value = finalTranscript.trim();
            // Auto-resize textarea
            promptInput.style.height = "auto";
            promptInput.style.height = Math.min(promptInput.scrollHeight, 120) + "px";
          } else if (interimTranscript) {
            // Show interim results with a different style
            promptInput.placeholder = `අසනවා: "${interimTranscript.trim()}"`;
          }
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          stopListening();
          
          let errorMsg = 'කටහඬ දෝෂය: ';
          switch(event.error) {
            case 'no-speech':
              errorMsg += 'කටහඬක් අසන්නෙ නැහැ';
              break;
            case 'audio-capture':
              errorMsg += 'මයික්‍රෝෆෝන් ප්‍රවේශ නැහැ';
              break;
            case 'not-allowed':
              errorMsg += 'මයික්‍රෝෆෝන් අනුමතිය නැහැ';
              break;
            case 'network':
              errorMsg += 'ජාල සම්බන්ධතාව නැහැ';
              break;
            default:
              errorMsg += 'නොදන්නා දෝෂයක්';
          }
          voiceStatus.textContent = errorMsg;
          
          setTimeout(() => {
            voiceStatus.textContent = 'කටහඬ සූදානම්';
          }, 3000);
        };
        
        recognition.onend = function() {
          stopListening();
          if (promptInput.value.trim()) {
            // Auto-submit after voice input
            setTimeout(() => {
              if (!isGenerating && promptInput.value.trim()) {
                handleSubmit();
              }
            }, 500);
          }
        };
        
        return true;
      } else {
        console.warn('Speech recognition not supported');
        voiceBtn.style.display = 'none';
        return false;
      }
    }

    // Start/Stop voice recognition
    function toggleVoiceInput() {
      if (!recognition) {
        voiceStatus.textContent = 'කටහඬ සහාය නැහැ';
        return;
      }
      
      if (isListening) {
        recognition.stop();
      } else {
        // Clear any previous text and start fresh
        promptInput.value = '';
        promptInput.placeholder = "ඔබේ ප්‍රශ්න මෙතන ලියන්න...";
        
        try {
          recognition.start();
        } catch (error) {
          console.error('Failed to start recognition:', error);
          voiceStatus.textContent = 'කටහඬ අරඹන්න අසමත්';
        }
      }
    }

    function stopListening() {
      isListening = false;
      voiceBtn.classList.remove('listening');
      inputBox.classList.remove('listening');
      voiceIndicator.classList.remove('listening');
      voiceStatus.textContent = 'කටහඬ සූදානම්';
      promptInput.placeholder = "ඔබේ ප්‍රශ්න මෙතන ලියන්න...";
    }

    // Text-to-Speech functions
    function speakMessage(button) {
      const message = button.closest('.message');
      const textContent = message.textContent.replace(/🔊/g, '').trim();
      speakText(textContent);
    }

    function speakText(text) {
      if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        voiceIndicator.classList.remove('speaking');
        voiceStatus.textContent = 'කටහඬ සූදානම්';
        return;
      }
      
      if (!text || text.trim() === '') return;
      
      // Clean text for better speech
      const cleanText = text
        .replace(/[🤖🙏📢🧪📚💻🗑️➡️🎤🔊]/g, '')
        .replace(/\*/g, '')
        .replace(/`/g, '')
        .trim();
      
      const utterance = new SpeechSynthesisUtterance(cleanText);
      
      // Configure voice settings
      utterance.rate = 0.8;
      utterance.pitch = 1.0;
      utterance.volume = 0.9;
      
      // Try to use Sinhala voice if available
      const voices = speechSynthesis.getVoices();
      const sinhalaVoice = voices.find(voice => 
        voice.lang.includes('si') || voice.lang.includes('ta') || voice.name.includes('Indian')
      );
      const englishVoice = voices.find(voice => 
        voice.lang.includes('en') && (voice.name.includes('Google') || voice.name.includes('Microsoft'))
      );
      
      if (sinhalaVoice) {
        utterance.voice = sinhalaVoice;
      } else if (englishVoice) {
        utterance.voice = englishVoice;
      }
      
      utterance.onstart = function() {
        isSpeaking = true;
        voiceIndicator.classList.add('speaking');
        voiceStatus.textContent = 'කියනවා...';
      };
      
      utterance.onend = function() {
        isSpeaking = false;
        voiceIndicator.classList.remove('speaking');
        voiceStatus.textContent = 'කටහඬ සූදානම්';
      };
      
      utterance.onerror = function(event) {
        console.error('Speech synthesis error:', event);
        isSpeaking = false;
        voiceIndicator.classList.remove('speaking');
        voiceStatus.textContent = 'කටහඬ දෝෂය';
        setTimeout(() => {
          voiceStatus.textContent = 'කටහඬ සූදානම්';
        }, 2000);
      };
      
      speechSynthesis.speak(utterance);
    }

    function toggleVoiceOutput() {
      autoVoiceOutput = !autoVoiceOutput;
      voiceToggle.classList.toggle('active', autoVoiceOutput);
      voiceToggleText.textContent = autoVoiceOutput ? 'සක්‍රීය' : 'අක්‍රීය';
      
      // Save setting to localStorage alternative (in-memory)
      window.voiceOutputSetting = autoVoiceOutput;
    }

    // Language detection function (same as before)
    function detectLanguage(text) {
      const cleanText = text.toLowerCase().replace(/[.,!?;:\s]+/g, ' ').trim();
      const sinhalaPattern = /[\u0D80-\u0DFF]/;
      
      const singlishPatterns = [
        /\b(mata|oba|eka|meka|tika|kiyanna|karanna|denna|ganna|puluwn|naha|ahnn|mokada|kohomada|ayye|nangi|aiya|akka|mama|api|oyala|meyala|wena|hadanna|banna|yanna|enna|awa|giya|kala|una)\b/i,
        /\b(da|ne|neda|hoda|nawatha|aniwa|ikmanata|sampurna|salli|amma|thaththa|duwa|putha|loku|podi|hari|nathi|thiyena|inne|hitiya)\b/i,
        /\b(ehema|ohoma|mona|kona|kawada|dawasa|rata|gaha|uda|yata|pita|ira|diga|asse|baya|salli|kama|bonawa|kanawa|yawanna)\b/i,
        /(ekak|ekai|ewage|wage|walata|wala|nisa|hinda|ekka|saha|athara|dakka|ahuwa|ahala|karala|una|giya|awa|tika|nam)/i
      ];
      
      const englishPatterns = [
        /\b(the|and|for|are|but|not|you|all|can|had|her|was|one|our|out|day|get|has|him|his|how|its|may|new|now|old|see|two|who|boy|did|what|with|have|from|they|know|want|been|good|much|some|time|very|when|come|here|just|like|long|make|many|over|such|take|than|them|well|were|will)\b/i,
        /\b(hello|hi|how|what|where|when|why|please|thank|thanks|yes|no|maybe|probably|definitely|absolutely|exactly|perfect|awesome|great|good|bad|nice|cool|amazing|wonderful)\b/i
      ];
      
      if (sinhalaPattern.test(text)) {
        return 'sinhala';
      }
      
      let singlishScore = 0;
      singlishPatterns.forEach(pattern => {
        const matches = cleanText.match(pattern);
        if (matches) singlishScore += matches.length;
      });
      
      let englishScore = 0;
      englishPatterns.forEach(pattern => {
        const matches = cleanText.match(pattern);
        if (matches) englishScore += matches.length;
      });
      
      if (singlishScore > englishScore && singlishScore > 0) {
        return 'singlish';
      } else if (englishScore > 0) {
        return 'english';
      } else {
        const hasRomanChars = /[a-zA-Z]/.test(text);
        return hasRomanChars ? 'english' : 'sinhala';
      }
    }

    function getSystemPrompt(language, userInput) {
      const prompts = {
        sinhala: `ඔබ සිංහල භාෂාවෙන් පිළිතුරු දෙන AI සහායකයෙක්. සිමහ විටම සම්පූර්ණයෙන්ම සිංහල අකුරුවලින් පිළිතුරු දෙන්න. ශ්‍රී ලංකික සංස්කෘතියට ගැළපෙන ආකාරයෙන් සහ මිත්‍රශීලීව ලෙස උත්තර දෙන්න.\n\nUser's question: ${userInput}`,
        
        singlish: `You are an AI assistant that responds in Singlish (Sri Lankan English mixed with Sinhala). Always reply in natural Singlish style like Sri Lankans speak. Use words like "mata", "oba", "eka", "puluwn", "naha", "karanna", etc. mixed with English. Be friendly and casual.\n\nUser's question: ${userInput}`,
        
        english: `You are a helpful AI assistant. Respond in clear, proper English. Be informative, friendly, and professional in your responses.\n\nUser's question: ${userInput}`
      };
      
      return prompts[language] || prompts.english;
    }

    function updateMessageCount() {
      messageCount++;
      messageCounter.textContent = messageCount;
    }

    function addMessage(text, sender, isError = false, isVoiceMessage = false) {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      if (isError) msg.classList.add("error");
      if (isVoiceMessage) msg.classList.add("voice-message");
      
      const formattedText = formatMessage(text);
      msg.innerHTML = formattedText;
      
      // Add voice controls for bot messages
      if (sender === 'bot') {
        const voiceControls = document.createElement('div');
        voiceControls.className = 'voice-controls';
        voiceControls.innerHTML = `
          <button class="voice-btn" onclick="speakMessage(this)" title="කටහඬින් අසන්න">🔊</button>
        `;
        msg.appendChild(voiceControls);
      }
      
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      if (sender === "user" || sender === "bot") {
        updateMessageCount();
      }
      
      // Auto-speak bot responses if enabled
      if (sender === 'bot' && autoVoiceOutput && !isError) {
        setTimeout(() => {
          speakText(text);
        }, 500);
      }
      
      return msg;
    }

    function formatMessage(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">$1</code>')
        .replace(/\n/g, '<br>');
    }
    
    function showTypingIndicator() {
      typingIndicator.style.display = 'flex';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }
    
    function setButtonState(disabled) {
      button.disabled = disabled;
      isGenerating = disabled;
      
      const icon = button.querySelector('span:first-child');
      const text = button.querySelector('span:last-child');
      
      if (disabled) {
        icon.textContent = '⏳';
        text.textContent = 'ලබයි...';
      } else {
        icon.textContent = '➡️';
        text.textContent = 'යවන්න';
      }
    }
    
    async function handleSubmit() {
      const prompt = promptInput.value.trim();
      if (!prompt || isGenerating) return;
      
      // Stop any ongoing speech
      if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        voiceIndicator.classList.remove('speaking');
        voiceStatus.textContent = 'කටහඬ සූදානම්';
      }
      
      const detectedLanguage = detectLanguage(prompt);
      const isVoiceInput = isListening || promptInput.classList.contains('voice-input');
      
      // Add user message
      addMessage(prompt, "user", false, isVoiceInput);
      promptInput.value = "";
      promptInput.classList.remove('voice-input');
      
      showTypingIndicator();
      setButtonState(true);

      try {
        const systemPrompt = getSystemPrompt(detectedLanguage, prompt);
        const result = await model.generateContent(systemPrompt);
        const response = result.response;
        const text = response.text();
        
        if (!text || text.trim() === "") {
          throw new Error("No text in response");
        }
        
        hideTypingIndicator();
        addMessage(text, "bot");
        
        conversationHistory.push({ 
          role: "user", 
          content: prompt,
          language: detectedLanguage 
        });
        conversationHistory.push({ 
          role: "model", 
          content: text,
          language: detectedLanguage 
        });
        
      } catch (error) {
        console.error("API Error:", error);
        hideTypingIndicator();
        
        let errorMsg = "⚠ දෝෂයක් සිදුවිය: ";
        if (error.message.includes("API_KEY")) {
          errorMsg += "API Key වලංගු නැත";
        } else if (error.message.includes("SAFETY")) {
          errorMsg += "Content policy හේතුවෙන් block විය";
        } else if (error.message.includes("QUOTA")) {
          errorMsg += "API quota අවසන්";
        } else if (error.message.includes("network") || error.message.includes("fetch")) {
          errorMsg += "Network connection ගැටළුව";
        } else {
          errorMsg += error.message || "නොදන්නා දෝෂයක්";
        }
        
        addMessage(errorMsg, "bot", true);
      } finally {
        setButtonState(false);
      }
    }

    // Global functions
    window.insertSample = function(topic) {
      const samples = {
        'ගණිතය': 'ගණිත ගැටළුවක් විසඳන්න: 2x + 5 = 15',
        'විද්‍යාව': 'ජල චක්‍රය ගැන කියන්න',
        'ඉතිහාසය': 'ශ්‍රී ලංකාවේ අනුරාධපුර යුගය ගැන කියන්න',
        'තාක්‍ෂණය': 'AI තාක්‍ෂණය ගැන සරලව පැහැදිලි කරන්න'
      };
      
      promptInput.value = samples[topic] || '';
      promptInput.focus();
    };

    window.clearChat = function() {
      if (confirm('සියලු පණිවිඩ මකා දමන්නද?')) {
        const firstMessage = messagesDiv.querySelector('.message.bot');
        const welcomeText = firstMessage.innerHTML;
        messagesDiv.innerHTML = '';
        
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message bot';
        welcomeMsg.innerHTML = welcomeText;
        messagesDiv.appendChild(welcomeMsg);
        
        conversationHistory = [];
        messageCount = 1;
        messageCounter.textContent = '1';
        promptInput.focus();
      }
    };

    window.speakMessage = function(button) {
      const message = button.closest('.message');
      const textContent = message.textContent.replace(/🔊/g, '').trim();
      speakText(textContent);
    };

    window.toggleVoiceOutput = toggleVoiceOutput;

    // Event listeners
    button.addEventListener("click", handleSubmit);
    voiceBtn.addEventListener("click", toggleVoiceInput);
    
    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSubmit();
      }
    });
    
    promptInput.addEventListener("input", () => {
      promptInput.style.height = "auto";
      const maxHeight = window.innerWidth <= 480 ? 80 : 120;
      promptInput.style.height = Math.min(promptInput.scrollHeight, maxHeight) + "px";
    });

    // Connection status
    function updateConnectionStatus(online) {
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-indicator span');
      
      if (online) {
        statusDot.style.background = 'var(--success-color)';
        statusText.textContent = 'සජීවී';
      } else {
        statusDot.style.background = 'var(--error-color)';
        statusText.textContent = 'නොසම්බන්ධ';
      }
    }
    
    window.addEventListener("online", () => updateConnectionStatus(true));
    window.addEventListener("offline", () => updateConnectionStatus(false));

    // Initialize everything
    window.addEventListener("load", () => {
      // Initialize speech recognition
      const speechSupported = initializeSpeechRecognition();
      
      if (!speechSupported) {
        voiceStatus.textContent = 'කටහඬ සහාය නැහැ';
        voiceBtn.disabled = true;
        voiceBtn.style.opacity = '0.5';
      }
      
      // Load voices for speech synthesis
      if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = function() {
          const voices = speechSynthesis.getVoices();
          console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
        };
      }
      
      // Restore voice output setting
      if (window.voiceOutputSetting) {
        autoVoiceOutput = true;
        voiceToggle.classList.add('active');
        voiceToggleText.textContent = 'සක්‍රීය';
      }
      
      // Focus handling
      if (window.innerWidth > 768) {
        promptInput.focus();
      }
      
      // Mobile viewport fix
      if (window.innerWidth <= 768) {
        const viewportHeight = window.innerHeight;
        document.documentElement.style.setProperty('--vh', `${viewportHeight * 0.01}px`);
      }
    });

    // Handle orientation change
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        if (window.innerWidth <= 768) {
          const viewportHeight = window.innerHeight;
          document.documentElement.style.setProperty('--vh', `${viewportHeight * 0.01}px`);
        }
      }, 100);
    });
  </script>
</body>
</html>
